name: Update cybersecurity brief

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_PUSH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run news updater
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NEWS_AGENT_FEEDS: ${{ secrets.NEWS_AGENT_FEEDS }}
        run: python scripts/update_news.py

      - name: Stage generated artefacts
        run: |
          git config user.name "evil-corporate-bot"
          git config user.email "actions@users.noreply.github.com"
          for path in docs/index.html data/news_cache.json data/agent_state.json data/commit_message.txt; do
            if [ -e "$path" ]; then
              git add "$path"
            fi
          done

      - name: Detect staged changes
        id: changes
        run: |
          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract commit message
        if: steps.changes.outputs.has_changes == 'true'
        id: commitmsg
        run: |
          commit_msg=$(cat data/commit_message.txt 2>/dev/null || echo "chore: refresh cybersecurity brief")
          title=$(printf '%s' "$commit_msg" | head -n1)
          {
            echo "message<<'EOF'"
            echo "$commit_msg"
            echo "EOF"
            echo "title<<'EOF'"
            echo "$title"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build pull request body
        if: steps.changes.outputs.has_changes == 'true'
        id: prbody
        run: |
          cat <<'PY' | python
          import json
          import os
          from pathlib import Path

          headline = "(headline unavailable)"
          narrative = "(no narrative provided)"
          key_themes = "- (none)"
          action_items = "- (none)"

          state_path = Path("data/agent_state.json")
          if state_path.exists():
              try:
                  data = json.loads(state_path.read_text())
                  latest = data.get("latest_brief") or {}
                  headline = latest.get("headline") or headline
                  narrative = latest.get("narrative") or narrative
                  themes = latest.get("key_themes") or []
                  actions = latest.get("action_items") or []
                  if themes:
                      key_themes = "\n".join(f"- {item}" for item in themes)
                  if actions:
                      action_items = "\n".join(f"- {item}" for item in actions)
              except Exception:
                  pass

          body = f"""## Summary
          - Automated refresh of the CyberNews cybersecurity brief generated by the resident LLM agent.

          ### Latest headline
          {headline}

          ### Narrative
          {narrative}

          ### Key themes
          {key_themes}

          ### Action items
          {action_items}
          """.strip()

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write("body<<'EOF'\n")
              handle.write(body + "\n")
              handle.write("EOF\n")
          PY

      - name: Derive branch name
        if: steps.changes.outputs.has_changes == 'true'
        id: branch
        run: |
          branch="bot/update-news-$(date -u +%Y%m%d-%H%M%S)"
          echo "name=$branch" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.changes.outputs.has_changes == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          commit-message: ${{ steps.commitmsg.outputs.message }}
          title: ${{ steps.commitmsg.outputs.title }}
          body: ${{ steps.prbody.outputs.body }}
          base: ${{ github.ref_name }}
          delete-branch: true

      - name: Close superseded bot pull requests
        if: steps.changes.outputs.has_changes == 'true' && steps.cpr.outputs['pull-request-number'] != ''
        uses: actions/github-script@v7
        env:
          CURRENT_PR: ${{ steps.cpr.outputs['pull-request-number'] }}
        with:
          github-token: ${{ secrets.PAT_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const currentPr = Number(process.env.CURRENT_PR || '0');
            if (!currentPr) {
              core.info('No pull request number available; skipping cleanup.');
              return;
            }

            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            for (const pr of prs) {
              if (pr.number === currentPr) {
                continue;
              }
              const ref = pr.head?.ref || '';
              if (!ref.startsWith('bot/update-news-')) {
                continue;
              }
              core.info(`Closing superseded bot PR #${pr.number} (${ref}).`);
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed',
              });
            }

      - name: Attempt automatic merge
        if: steps.changes.outputs.has_changes == 'true' && steps.cpr.outputs['pull-request-number'] != ''
        uses: actions/github-script@v7
        env:
          CURRENT_PR: ${{ steps.cpr.outputs['pull-request-number'] }}
        with:
          github-token: ${{ secrets.PAT_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const currentPr = Number(process.env.CURRENT_PR || '0');
            if (!currentPr) {
              core.info('No pull request number available; skipping auto-merge.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function attemptMerge() {
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: currentPr,
                  merge_method: 'squash',
                });
                core.info(`Successfully merged PR #${currentPr}.`);
                return true;
              } catch (error) {
                if (error.status === 409) {
                  core.warning(`Unable to merge PR #${currentPr} automatically: ${error.message}`);
                  return false;
                }
                throw error;
              }
            }

            const merged = await attemptMerge();
            if (!merged) {
              const message = [
                '⚠️ The automated agent could not merge this update because GitHub reported conflicts with the base branch.',
                'Please resolve the conflicts manually or close this pull request before the next scheduled run.',
              ].join('\n\n');

              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: currentPr,
              });

              const alreadyNotified = comments.some(comment => comment.body?.trim() === message.trim());
              if (alreadyNotified) {
                core.info('Conflict notification already present on the pull request.');
                return;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: currentPr,
                body: message,
              });
            }

      - name: No changes detected
        if: steps.changes.outputs.has_changes != 'true'
        run: echo "No updates from the agent run."
